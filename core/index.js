// core/index.js
const config = require('../config');
const database = require('./database');
const repositories = require('./repositories');
const services = require('./services');
const controllers = require('./controllers');
const middleware = require('./middleware');

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤—Å–µ —è–¥—Ä–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * @returns {Promise<Object>} –û–±—ä–µ–∫—Ç —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
 */
async function initCore() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —è–¥—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
    
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    const { connection } = await database.initDatabase(config.database);
    console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∞');
    
    // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
    const repoInstances = repositories.init(connection);
    console.log('‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
    
    // 3. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
    const serviceInstances = services.init(repoInstances, config.jwtSecret || 'default-secret-key');
    console.log('‚úÖ –°–µ—Ä–≤–∏—Å—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
    
    // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤
    const controllerInstances = controllers.init(serviceInstances);
    console.log('‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');

    // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è middleware
    const middlewareInstances = middleware.init(serviceInstances);
    console.log('‚úÖ Middleware –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
    
    return {
        connection,
        controllers: controllerInstances, // ‚úÖ –Ø–≤–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º controllers
        services: serviceInstances,
        repositories: repoInstances,
        middleware: middlewareInstances,
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è graceful shutdown
        closeDatabase: () => database.closeDatabase(connection)
    };
}

module.exports = { initCore };